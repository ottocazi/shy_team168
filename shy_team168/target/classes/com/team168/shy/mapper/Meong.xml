<?xml version="1.0" encoding="UTF-8"?>

<!-- ===== #26. mapper 기본설정 ===== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- ===== #27. 루트엘리먼트 & 네임스페이스 설정(프로젝트 전체 내에서 고유해야 한다.) ===== -->
<mapper namespace="mangu">

	<!-- 회원가입 -->
	<insert id="addregistorEnd" parameterType="java.util.HashMap">
		insert into tbl_shymember(idx, name, email, pwd, registerdate, status) 
		values(seq_tbl_shymember.nextval, #{name}, #{email}, #{pwd}, default, default)  
	</insert>
	
	<!-- 로그인 여부 알아오기 -->
	<select id="loginEnd" parameterType="java.util.HashMap" resultType="int"> 
		select case( select count(*)
	                 from tbl_shymember
	                 where email = #{email} and
	                       pwd = #{pwd} )
	           when 1 then 1
	           else( case(select count(*) 
	                      from tbl_shymember
	                      where email = #{email})
	                 when 1 then 0
	                 else -1
	                 end
	               )
	           end as LOGINCHECK
	  from dual
	</select>
	
	<!-- 로그인 성공한 사용자 정보 가져오기 -->
	<select id="getLoginMember" parameterType="String" resultType="com.team168.shy.model.ShyMemberVO"> 
       select idx, name, email, pwd
       , to_char(registerdate, 'yyyy-mm-dd') as registerdate
       , myimg, myintro, birthday, gender, phone
	   from tbl_shymember
	   where status = 1 and email = #{email} 
	</select>
	
	<!-- 로그인한 유저 로그기록 저장하기 -->
	<insert id="loginsert" parameterType="java.util.HashMap">
		insert into tbl_log(logno, fk_idx, status, logtime, logip) 
		values(seq_tbl_log.nextval, #{user_seq}, 1, to_date(#{today}, 'yyyy-mm-dd hh24:mi:ss'), #{user_ip})
	</insert>	

	<!-- 로그아웃한 유저 로그기록 저장하기(미완성) -->
	<insert id="logoutinsert" parameterType="java.util.HashMap">
		insert into tbl_log(logno, fk_idx, status, logtime, logip) 
		values(seq_tbl_log.nextval, #{user_seq}, 0, to_date(#{today}, 'yyyy-mm-dd hh24:mi:ss'), #{user_ip})
	</insert>	
	
	<!-- 통계를 위한 셀렉트문 -->	
	<select id="gettotaluser" resultType="String">
		select count(*)
		from tbl_shymember
	</select>
		
	<select id="getmentotal" resultType="String">
		select count(*)
		from tbl_shymember
		where gender = '남자'
	</select>
		
	<select id="getwomantotal" resultType="String">
		select count(*)
		from tbl_shymember
		where gender = '여자'
	</select>		
		
	<select id="gettodaytotal" resultType="String">
		select distinct count(fk_idx) 
		from tbl_log 
		where status = 1 and rowid in (select max(rowid) from tbl_log group by fk_idx)
	</select>		
	
	<!-- 공지사항(미정)부분에서 회원목록 보여주는 select 문 -->
	<resultMap type="java.util.HashMap" id="getshyListMap">
		<result property="IDX" 		        column="idx" 	        javaType="String" />
 		<result property="NAME" 	        column="name" 	        javaType="String" />
 		<result property="EMAIL" 		    column="email" 	        javaType="String" />
 		<result property="PWD" 	            column="pwd" 	        javaType="String" />
 		<result property="REGISTERDATE"		column="registerdate" 	javaType="String" />
 		<result property="STATUS" 	        column="status" 	    javaType="String" />
 		<result property="MYIMG" 		    column="myimg" 	        javaType="String" />
 		<result property="MYINTRO" 	        column="myintro" 	    javaType="String" />
 		<result property="BIRTHDAY" 		column="birthday" 	    javaType="String" />
 		<result property="GENDER" 	        column="gender" 	    javaType="String" />
 		<result property="PHONE" 		    column="phone" 	        javaType="String" />
	</resultMap>
	<select id="getshyList" parameterType="java.util.HashMap" resultMap="getshyListMap">
		select idx, name, email, pwd, registerdate, status, myimg, myintro, birthday, gender, phone
		from
		(
		select rownum as RNO
		, idx, name, email, pwd, registerdate, status, myimg, myintro, birthday, gender, phone
		from
		(
		select idx, name, email, pwd
		     , to_char(registerdate, 'yyyy-mm-dd hh24:mi:ss') as registerdate
		     , status, myimg, myintro, birthday, gender, phone
		     from tbl_shymember
		     where status = 1
		     order by idx desc
		)V
		)T
		where T.RNO >= #{start} and T.RNO <![CDATA[<=]]> #{end}
	</select>
	
	<!-- 페이징처리를 위해 총회원수 -->
	<select id="getTotalCount" parameterType="java.util.HashMap" resultType="int"> 
		select count(*)
		from tbl_shymember
		where status = 1
	</select>     
	
	<!-- 공지사항(미정)부분 회원에 대한 게시물조회 -->
	<select id="getmemocount" parameterType="String" resultType="String">
		select count(*) 
		from tbl_shymemo
		where fk_idx = #{COUNT}
	</select>
	
	
	<resultMap type="java.util.HashMap" id="getshyListmap">
		<result property="IDX" 		        column="idx" 	        javaType="int" />
 		<result property="NAME" 	        column="name" 	        javaType="String" />
 		<result property="EMAIL" 		    column="email" 	        javaType="String" />
 		<result property="PWD" 	            column="pwd" 	        javaType="String" />
 		<result property="REGISTERDATE"		column="registerdate" 	javaType="String" />
 		<result property="STATUS" 	        column="status" 	    javaType="int" />
 		<result property="MYIMG" 		    column="myimg" 	        javaType="String" />
 		<result property="MYINTRO" 	        column="myintro" 	    javaType="String" />
 		<result property="BIRTHDAY" 		column="birthday" 	    javaType="String" />
 		<result property="GENDER" 	        column="gender" 	    javaType="String" />
 		<result property="PHONE" 		    column="phone" 	        javaType="String" />
	</resultMap>
	<select id="shyList" parameterType="java.util.HashMap" resultMap="getshyListmap">
		select * 
		from tbl_shymember
		order by idx desc
	</select>

	<update id="shystatusDown"  parameterType="java.util.HashMap">
		update tbl_shymember
		set status = 0
		where idx = #{idx}
	</update>

	<update id="shystatusUp"  parameterType="java.util.HashMap">
		update tbl_shymember
		set status = 1
		where idx = #{idx}
	</update>
	
	<!-- 하루(시간대별) 통계를 위한 쿼리문 -->
	<resultMap type="java.util.HashMap" id="gettongkeListmap">
		<result property="DAY" 	        column="day" 	    javaType="String" />
 		<result property="TIME" 		    column="time" 	        javaType="String" />
 		<result property="CNT" 	        column="cnt" 	    javaType="String" />
	</resultMap>
	<select id="gettongkeList" resultMap="gettongkeListmap" parameterType="java.util.HashMap">
		select A.time as day, substr(A.time, 12, 13) AS TIME, nvl(B.cnt, 0) as cnt
		from (SELECT TO_CHAR(TO_DATE(#{today}, 'YYYY-MM-DD') + ((LEVEL - 1) / 24), 'YYYY-MM-DD hh24') as time FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]> 24) A
		left outer join (select time, count(time) as cnt from (SELECT TO_CHAR(logtime, 'YYYY-MM-DD hh24') as time from tbl_log where to_char(logtime, 'yyyy-mm-dd') = #{today}) group by time) B
		on A.time = B.time
		order by time asc
	</select>
	
	<!-- 하루(시간대별) 통계를 위한 쿼리문 -->
	<resultMap type="java.util.HashMap" id="gettongkeList2map">
		<result property="DAY" 	        column="day" 	    javaType="String" />
 		<result property="TIME" 		    column="time" 	        javaType="String" />
 		<result property="CNT" 	        column="cnt" 	    javaType="String" />
	</resultMap>
	<select id="gettongkeList2" resultMap="gettongkeList2map" parameterType="java.util.HashMap">
		select A.time as day, substr(A.time, 12, 13) AS TIME, nvl(B.cnt, 0) as cnt
		from (SELECT TO_CHAR(TO_DATE(#{yesterday}, 'YYYY-MM-DD') + ((LEVEL - 1) / 24), 'YYYY-MM-DD hh24') as time FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]> 24) A
		left outer join (select time, count(time) as cnt from (SELECT TO_CHAR(logtime, 'YYYY-MM-DD hh24') as time from tbl_log where to_char(logtime, 'yyyy-mm-dd') = #{yesterday}) group by time) B
		on A.time = B.time
		order by time asc
	</select>
	
	
	<!-- 성민 -->
	    <resultMap type="java.util.HashMap" id="searchpeopleMap">
		<result property="IDX" 			column="idx" 			javaType="String" />
 		<result property="NAME"  		column="name" 			javaType="String" />
 		<result property="EMAIL"  		column="email" 			javaType="String" />
 		<result property="PWD"  		column="pwd" 			javaType="String" />
 		<result property="REGISTERDATE" column="registerdate" 	javaType="String" />
 		<result property="MYIMG"  		column="myimg" 			javaType="String" />
 		<result property="MYINTRO"  	column="myintro" 		javaType="String" />
 		<result property="BIRTHDAY" 	column="birthday" 		javaType="String" />
 		<result property="GENDER"  		column="gender" 		javaType="String" />
 		<result property="PHONE"  		column="phone" 			javaType="String" />
	</resultMap>
	 <select id="plist" parameterType="String" resultMap="searchpeopleMap">
	    select *
        from tbl_shymember
        where status = 1
        order by idx desc
	</select> 
	
	
	<!-- =====  ===== -->
	<resultMap type="java.util.HashMap" id="getFollowListArrMap">
		<result property="IDX" column="IDX" javaType="String"/>
		<result property="FOLLOWCHECK" column="FOLLOWCHECK" javaType="int"/>
	</resultMap>
	
	<select id="getFollowListArr" resultMap="getFollowListArrMap" parameterType="java.util.HashMap">
		SELECT A.IDX, NVL(B.STATUS, 0) AS FOLLOWCHECK
		FROM (SELECT * FROM TBL_SHYMEMBER WHERE IDX IN 
			<foreach collection="idxArr" item="item" index="i"  separator="," open="(" close=")">
				  ${idxArr[i]}
			</foreach>
													   )A 
			  LEFT OUTER JOIN  
      		 (SELECT *  FROM TBL_FOLLOW WHERE FK_IDXFLW = #{idx}  ) B
      		  ON A.IDX = B.FK_IDXFLWED
	</select>
	
	<!-- 운영자 리스트보여주는 select문 -->
	<resultMap type="java.util.HashMap" id="getadminListMap">
		<result property="IDX" 		        column="idx" 	        javaType="String" />
 		<result property="NAME" 	        column="name" 	        javaType="String" />
 		<result property="EMAIL" 		    column="email" 	        javaType="String" />
 		<result property="PWD" 	            column="pwd" 	        javaType="String" />
 		<result property="REGISTERDATE"		column="registerdate" 	javaType="String" />
 		<result property="STATUS" 	        column="status" 	    javaType="String" />
 		<result property="MYIMG" 		    column="myimg" 	        javaType="String" />
 		<result property="MYINTRO" 	        column="myintro" 	    javaType="String" />
 		<result property="BIRTHDAY" 		column="birthday" 	    javaType="String" />
 		<result property="GENDER" 	        column="gender" 	    javaType="String" />
 		<result property="PHONE" 		    column="phone" 	        javaType="String" />
	</resultMap>
	<select id="getadminList" parameterType="String" resultMap="getadminListMap">
		select *
		from tbl_shymember
		order by idx desc
	</select>
	
	
	
	
</mapper>






