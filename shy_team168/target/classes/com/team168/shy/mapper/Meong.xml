<?xml version="1.0" encoding="UTF-8"?>

<!-- ===== #26. mapper 기본설정 ===== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- ===== #27. 루트엘리먼트 & 네임스페이스 설정(프로젝트 전체 내에서 고유해야 한다.) ===== -->
<mapper namespace="mangu">

	<!-- 회원가입 -->
	<insert id="addregistorEnd" parameterType="java.util.HashMap">
		insert into tbl_shymember(idx, name, email, pwd, registerdate, status) 
		values(seq_tbl_shymember.nextval, #{name}, #{email}, #{pwd}, default, default)  
	</insert>
	
	<!-- 로그인 여부 알아오기 -->
	<select id="loginEnd" parameterType="java.util.HashMap" resultType="int"> 
		select case( select count(*)
	                 from tbl_shymember
	                 where email = #{email} and
	                       pwd = #{pwd} )
	           when 1 then 1
	           else( case(select count(*) 
	                      from tbl_shymember
	                      where email = #{email})
	                 when 1 then 0
	                 else -1
	                 end
	               )
	           end as LOGINCHECK
	  from dual
	</select>
	
	<!-- 로그인 성공한 사용자 정보 가져오기 -->
	<select id="getLoginMember" parameterType="String" resultType="com.team168.shy.model.ShyMemberVO"> 
       select idx, name, email, pwd
       , to_char(registerdate, 'yyyy-mm-dd') as registerdate
       , myimg, myintro, birthday, gender, phone
	   from tbl_shymember
	   where status = 1 and email = #{email} 
	</select>
	
	<!-- 로그인한 유저 로그기록 저장하기 -->
	<insert id="loginsert" parameterType="java.util.HashMap">
		insert into tbl_log(logno, fk_idx, status, logtime, logip) 
		values(seq_tbl_log.nextval, #{user_seq}, 1, to_date(#{today}, 'yyyy-mm-dd hh24:mi:ss'), #{user_ip})
	</insert>	

	<!-- 로그아웃한 유저 로그기록 저장하기(미완성) -->
	<insert id="logoutinsert" parameterType="java.util.HashMap">
		insert into tbl_log(logno, fk_idx, status, logtime, logip) 
		values(seq_tbl_log.nextval, #{user_seq}, 0, to_date(#{today}, 'yyyy-mm-dd hh24:mi:ss'), #{user_ip})
	</insert>	
	
	<!-- 통계를 위한 셀렉트문 -->	
	<select id="gettotaluser" resultType="String">
		select count(*)
		from tbl_shymember
	</select>
		
	<select id="getmentotal" resultType="String">
		select count(*)
		from tbl_shymember
		where gender = '남자'
	</select>
		
	<select id="getwomantotal" resultType="String">
		select count(*)
		from tbl_shymember
		where gender = '여자'
	</select>		
		
	<select id="gettodaytotal" resultType="String">
		select distinct count(fk_idx) 
		from tbl_log 
		where status = 1 and rowid in (select max(rowid) from tbl_log group by fk_idx)
	</select>		
	
	<!-- 회원목록 보여주는 select 문 -->
	<resultMap type="java.util.HashMap" id="getshyListMap">
		<result property="IDX" 		        column="idx" 	        javaType="String" />
 		<result property="NAME" 	        column="name" 	        javaType="String" />
 		<result property="EMAIL" 		    column="email" 	        javaType="String" />
 		<result property="PWD" 	            column="pwd" 	        javaType="String" />
 		<result property="REGISTERDATE"		column="registerdate" 	javaType="String" />
 		<result property="STATUS" 	        column="status" 	    javaType="String" />
 		<result property="MYIMG" 		    column="myimg" 	        javaType="String" />
 		<result property="MYINTRO" 	        column="myintro" 	    javaType="String" />
 		<result property="BIRTHDAY" 		column="birthday" 	    javaType="String" />
 		<result property="GENDER" 	        column="gender" 	    javaType="String" />
 		<result property="PHONE" 		    column="phone" 	        javaType="String" />
	</resultMap>
	<select id="getshyList" parameterType="java.util.HashMap" resultMap="getshyListMap">
		select idx, name, email, pwd, registerdate, status, myimg, myintro, birthday, gender, phone
		from
		(
		select rownum as RNO
		, idx, name, email, pwd, registerdate, status, myimg, myintro, birthday, gender, phone
		from
		(
		select idx, name, email, pwd
		     , to_char(registerdate, 'yyyy-mm-dd hh24:mi:ss') as registerdate
		     , status, myimg, myintro, birthday, gender, phone
		     from tbl_shymember
		     where status = 1
		     order by idx desc
		)V
		)T
		where T.RNO >= #{start} and T.RNO <![CDATA[<=]]> #{end}
	</select>
	
	<!-- 페이징처리를 위해 총회원수 -->
	<select id="getTotalCount" parameterType="java.util.HashMap" resultType="int"> 
		select count(*)
		from tbl_shymember
		where status = 1
	</select>     
	
	<!-- 관리자페이지 회원에 대한 게시물조회 -->
	<select id="getmemocount" parameterType="String" resultType="String">
		select count(*) 
		from tbl_shymemo
		where fk_idx = #{COUNT}
	</select>
	
	<select id="shyList" resultType="com.team168.shy.model.ShyMemberVO">
		select *
		from tbl_shymember
		where status = 1
		order by idx desc
	</select>
</mapper>






