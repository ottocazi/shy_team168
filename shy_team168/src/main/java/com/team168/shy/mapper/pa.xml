<?xml version="1.0" encoding="UTF-8"?>

<!-- =====   mapper 기본설정 ===== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- =====   루트엘리먼트 & 네임스페이스 설정(프로젝트 전체 내에서 고유해야 한다.) ===== -->
<mapper namespace="pa">

	<!-- ===== 6. Ajax 로 검색어 입력시 자동글 완성하기 =====  -->
	<resultMap type="java.util.HashMap" id="getSearchWordMap">
		<result property="SEARCHDATA" column="searchdata" javaType="String" />
	</resultMap>
	<select id="searchWordgrpList" parameterType="java.util.HashMap" resultMap="getSearchWordMap"> 
		<if test='colname.equals("gname")'>
		    select gname as searchdata 
		    from tbl_group
		    where lower(gname) like '%' || lower(#{grpsearch}) || '%'
		</if>
		
		<if test='colname.equals("gcontent")'>
		    select substr(gcontent, instr(gcontent, #{grpsearch}, 1, 1), length(#{grpsearch}) + 5 )
		           as searchdata    
		    from tbl_grpboard
		    where lower(gcontent) like '%' || lower(#{grpsearch}) || '%'
		</if>
	</select>
	
	<!-- ===== 그룹만들기 ===== -->	
	<insert id="grpinsert" parameterType="com.team168.shy.model.GroupVO">
		insert into tbl_group(groupno, fk_idx, gname, description, gimg, status, groupdate,gcount)
		values(seq_tbl_group.nextval, #{fk_idx}, #{gname}, #{description}, #{gimg}, #{status} , default,default)
	</insert>
	
	<!-- ===== 그룹멤버 insert ===== -->	
	<insert id="gmemberinsert" parameterType="java.util.HashMap">
		insert into tbl_gmember(gpdetailno,fk_groupno,fk_groupidx,gregisterdate,status) 
		values(seq_tbl_gmember.nextval,#{fk_groupno},#{fk_groupidx},default,default)
	</insert>
	
	<!-- ===== 인기그룹 가져오기 =====  -->
	<select id="hotGrpList" resultType="com.team168.shy.model.GroupVO"> 
		 select  groupno, fk_idx, gname, description, gimg, status, groupdate, gcount,
				 rank() over (order by gcount desc) as rank
		 from tbl_group
		 order by rank
	</select>
	
	<!-- ===== 그룹 가져오기 =====  -->
	<select id="selectGvo" resultType="com.team168.shy.model.GroupVO"> 
		 select  groupno, fk_idx, gname, description, gimg, status, groupdate, gcount
		 from tbl_group
		 where to_char(groupdate,'yyyy-mm-dd hh:mi:ss') = to_char(sysdate,'yyyy-mm-dd hh:mi:ss')
	</select>
	
	<!-- ===== 신규그룹 가져오기 =====  -->
	<select id="newGrpList" resultType="com.team168.shy.model.GroupVO"> 
		 select  groupno, fk_idx, gname, description, gimg, status, groupdate, gcount
		 from tbl_group
		 order by groupdate desc
	</select>
	
	<!-- ===== 내그룹 가져오기(내가 만든것) =====  -->
	<select id="myGrpList" parameterType="int" resultType="com.team168.shy.model.GroupVO"> 
		 select  *
		 from tbl_group
		 where fk_idx=#{fk_idx}
	</select>
	
	<!-- ===== 그룹 디테일보기 =====  -->
	<resultMap type="java.util.HashMap" id="groupDetailMap">
		<result property="GROUPNO" 				column="groupno" 			javaType="int" />
 		<result property="FK_IDX" 			column="fk_idx" 			javaType="String" />
 		<result property="GNAME" 			column="gname" 			javaType="String" />
 		<result property="DESCRIPTION" 			column="description" 		javaType="String" />
 		<result property="GROUPDATE" 			column="groupdate" 			javaType="String" />
 		<result property="STATUS" 	column="status" 	javaType="int" />
 		<result property="GIMG" 	column="gimg" 	javaType="String" />
 		<result property="GCOUNT" 	column="gcount" 	javaType="int" />
 		<result property="NAME" 	column="name" 	javaType="String" />
 		<result property="EMAIL" 	column="email" 	javaType="String" />
 		<result property="MYIMG" 	column="myimg" 	javaType="String" />
 		<result property="MYINTRO" 	column="myintro" 	javaType="String" />
	</resultMap>
	<select id="groupDetail" parameterType="int" resultMap="groupDetailMap"> 
		select groupno,fk_idx, gname,description,groupdate,status,gimg,gcount,name,email,myimg,myintro
		from view_tbl_group
		where groupno = #{groupno}
	</select>
	
	<!-- ===== 그룹멤버 정보 가져오기 =====  -->
	<resultMap type="java.util.HashMap" id="groupMemberMap">
		<result property="GROUPNO" 				column="groupno" 			javaType="int" />
		<result property="GPDETAILNO" 				column="gpdetailno" 			javaType="int" />
 		<result property="FK_GROUPIDX" 			column="fk_groupidx" 			javaType="String" />
 		<result property="GREGISTERDATE" 			column="gregisterdate" 			javaType="String" />
 		<result property="STATUS" 	column="status" 	javaType="int" />
 		<result property="NAME" 	column="name" 	javaType="String" />
 		<result property="EMAIL" 	column="email" 	javaType="String" />
 		<result property="MYIMG" 	column="myimg" 	javaType="String" />
	</resultMap>
	<select id="gmemberList" parameterType="int" resultMap="groupMemberMap"> 
		 select name,email,myimg, groupno , gpdetailno, fk_groupidx, gregisterdate, status
		 from
		  (select C.name,C.email,C.myimg, V.*
		  from tbl_shymember C join 
		  (
		   select A.groupno ,B.gpdetailno,B.fk_groupidx,B.gregisterdate,B.status
		   from tbl_group A join tbl_gmember B 
		   on A.groupno = B.fk_groupno
		  )V
		  on V.fk_groupidx=C.idx)T
		 where T.groupno = #{groupno}
	</select>
	
	<!-- ===== 그룹만들기 ===== -->	
	<insert id="gboardWrite" parameterType="java.util.HashMap">
		<if test='!uploadfile.equals("")'>
		insert into tbl_grpboard(grpboardseq,gpdetailno,gcontent,uploadfile,writedate,likecnt,cmtcnt,imgyn,status)
		values(seq_tbl_grpboard.nextval, #{gpdetailno}, #{gcontent}, #{uploadfile}, default,default, default,1,default)
		</if>
		<if test='uploadfile.equals("")'>
		insert into tbl_grpboard(grpboardseq,gpdetailno,gcontent,uploadfile,writedate,likecnt,cmtcnt,imgyn,status)
		values(seq_tbl_grpboard.nextval, #{gpdetailno}, #{gcontent}, #{uploadfile}, default,default, default,default,default)
		</if>
	</insert>
	
	<!-- ===== 그룹글 목록 가져오기 ===== -->	
	<resultMap type="java.util.HashMap" id="groupBoardMap">
		<result property="FK_GROUPNO" 				column="fk_groupno" 			javaType="int" />
		<result property="GPDETAILNO" 				column="gpdetailno" 			javaType="int" />
		<result property="GRPBOARDSEQ" 				column="grpboardseq" 			javaType="int" />
 		<result property="FK_GROUPIDX" 			column="fk_groupidx" 			javaType="String" />
 		<result property="GCONTENT" 			column="gcontent" 			javaType="String" />
 		<result property="UPLOADFILE" 			column="uploadfile" 			javaType="String" />
 		<result property="WRITEDATE" 			column="writedate" 			javaType="String" />
 		<result property="LIKECNT" 	column="likecnt" 	javaType="int" />
 		<result property="CMTCNT" 	column="cmtcnt" 	javaType="int" />
 		<result property="IMGYN" 	column="imgyn" 	javaType="int" />
 		<result property="STATUS" 	column="status" 	javaType="int" />
 		<result property="NAME" 	column="name" 	javaType="String" />
 		<result property="EMAIL" 	column="email" 	javaType="String" />
 		<result property="MYIMG" 	column="myimg" 	javaType="String" />
	</resultMap>
	<select id="gboardList" parameterType="int" resultMap="groupBoardMap"> 
		select name,email,myimg,fk_groupno,fk_groupidx,grpboardseq,gpdetailno,gcontent,uploadfile,writedate,likecnt,cmtcnt,imgyn,status
		from
		(
		select C.name,C.email,C.myimg,V.*
		from tbl_shymember C join
		(
		select A.fk_groupno,A.fk_groupidx,B.grpboardseq,B.gpdetailno,B.gcontent,B.uploadfile,B.writedate,B.likecnt,B.cmtcnt,B.imgyn,B.status
		from tbl_gmember A join tbl_grpboard B
		on A.gpdetailno = B.gpdetailno)V
		on C.idx = V.fk_groupidx
		)T
		where T.fk_groupno=#{groupno}
	</select>
</mapper>	